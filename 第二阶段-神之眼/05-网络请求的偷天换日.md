# 05. ç½‘ç»œè¯·æ±‚çš„"å·å¤©æ¢æ—¥"

## ğŸ“š å­¦ä¹ ç›®æ ‡

- æŒæ¡ `declarativeNetRequest` API çš„ä½¿ç”¨
- å®ç°åŠ¨æ€ä¿®æ”¹è¯·æ±‚ Headers
- è§£å†³è·¨åŸŸï¼ˆCORSï¼‰é—®é¢˜
- ç†è§£è¯·æ±‚æ‹¦æˆªä¸ä¿®æ”¹çš„æœ€ä½³å®è·µ

## ğŸ¯ æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. declarativeNetRequest æ¦‚è¿°

`declarativeNetRequest` æ˜¯ Manifest V3 ä¸­ç”¨äºç½‘ç»œè¯·æ±‚æ‹¦æˆªå’Œä¿®æ”¹çš„ APIï¼Œç›¸æ¯” V2 çš„ `webRequest` APIï¼š

**ä¼˜åŠ¿ï¼š**
- æ€§èƒ½æ›´å¥½ï¼ˆå£°æ˜å¼ï¼Œæµè§ˆå™¨åŸç”Ÿå¤„ç†ï¼‰
- éšç§æ›´å®‰å…¨ï¼ˆä¸éœ€è¦è¯»å–è¯·æ±‚ä½“ï¼‰
- æ”¯æŒæ›´å¤šè§„åˆ™ç±»å‹

**é™åˆ¶ï¼š**
- ä¸èƒ½è¯»å–è¯·æ±‚/å“åº”ä½“
- è§„åˆ™æ•°é‡æœ‰é™åˆ¶ï¼ˆ30,000 æ¡ï¼‰
- æŸäº›æ“ä½œéœ€è¦ `host_permissions`

### 2. åŸºç¡€é…ç½®

#### manifest.json é…ç½®

```json
{
  "manifest_version": 3,
  "permissions": [
    "declarativeNetRequest",
    "declarativeNetRequestWithHostAccess"
  ],
  "host_permissions": [
    "https://*/*",
    "http://*/*"
  ],
  "declarative_net_request": {
    "rule_resources": [
      {
        "id": "ruleset_1",
        "enabled": true,
        "path": "rules.json"
      }
    ]
  }
}
```

#### é™æ€è§„åˆ™ï¼ˆrules.jsonï¼‰

```json
[
  {
    "id": 1,
    "priority": 1,
    "action": {
      "type": "modifyHeaders",
      "requestHeaders": [
        {
          "header": "User-Agent",
          "operation": "set",
          "value": "Mozilla/5.0 (Custom Bot)"
        },
        {
          "header": "Referer",
          "operation": "set",
          "value": "https://example.com"
        }
      ]
    },
    "condition": {
      "urlFilter": "*example.com*",
      "resourceTypes": ["xmlhttprequest", "main_frame"]
    }
  }
]
```

### 3. åŠ¨æ€è§„åˆ™ç®¡ç†

#### æ·»åŠ åŠ¨æ€è§„åˆ™

```typescript
// src/background/netRequest.ts
import { chrome } from '@/shared/types/chrome';

interface Rule {
  id: number;
  priority: number;
  action: chrome.declarativeNetRequest.RuleAction;
  condition: chrome.declarativeNetRequest.RuleCondition;
}

export class NetRequestManager {
  private ruleIdCounter = 10000; // ä» 10000 å¼€å§‹ï¼Œé¿å…ä¸é™æ€è§„åˆ™å†²çª

  async addRule(rule: Omit<Rule, 'id'>): Promise<number> {
    const id = this.ruleIdCounter++;
    const fullRule: Rule = { ...rule, id };

    await chrome.declarativeNetRequest.updateDynamicRules({
      addRules: [fullRule],
    });

    return id;
  }

  async removeRule(ruleId: number): Promise<void> {
    await chrome.declarativeNetRequest.updateDynamicRules({
      removeRuleIds: [ruleId],
    });
  }

  async updateRule(rule: Rule): Promise<void> {
    await chrome.declarativeNetRequest.updateDynamicRules({
      removeRuleIds: [rule.id],
      addRules: [rule],
    });
  }

  async getAllRules(): Promise<Rule[]> {
    return await chrome.declarativeNetRequest.getDynamicRules();
  }

  async clearAllRules(): Promise<void> {
    const rules = await this.getAllRules();
    await chrome.declarativeNetRequest.updateDynamicRules({
      removeRuleIds: rules.map(r => r.id),
    });
  }
}
```

#### å¸¸ç”¨è§„åˆ™æ¨¡æ¿

```typescript
// src/shared/utils/netRequestTemplates.ts
import { chrome } from '@/shared/types/chrome';

export const ruleTemplates = {
  // ä¿®æ”¹ User-Agent
  modifyUserAgent: (
    urlPattern: string,
    userAgent: string
  ): chrome.declarativeNetRequest.Rule => ({
    id: 0, // ä¼šè¢«è‡ªåŠ¨åˆ†é…
    priority: 1,
    action: {
      type: chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,
      requestHeaders: [
        {
          header: 'User-Agent',
          operation: chrome.declarativeNetRequest.HeaderOperation.SET,
          value: userAgent,
        },
      ],
    },
    condition: {
      urlFilter: urlPattern,
      resourceTypes: [
        chrome.declarativeNetRequest.ResourceType.MAIN_FRAME,
        chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST,
      ],
    },
  }),

  // æ·»åŠ  Referer
  addReferer: (
    urlPattern: string,
    referer: string
  ): chrome.declarativeNetRequest.Rule => ({
    id: 0,
    priority: 1,
    action: {
      type: chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,
      requestHeaders: [
        {
          header: 'Referer',
          operation: chrome.declarativeNetRequest.HeaderOperation.SET,
          value: referer,
        },
      ],
    },
    condition: {
      urlFilter: urlPattern,
    },
  }),

  // æ·»åŠ è‡ªå®šä¹‰ Header
  addCustomHeader: (
    urlPattern: string,
    headerName: string,
    headerValue: string
  ): chrome.declarativeNetRequest.Rule => ({
    id: 0,
    priority: 1,
    action: {
      type: chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,
      requestHeaders: [
        {
          header: headerName,
          operation: chrome.declarativeNetRequest.HeaderOperation.SET,
          value: headerValue,
        },
      ],
    },
    condition: {
      urlFilter: urlPattern,
    },
  }),

  // é˜»æ­¢è¯·æ±‚
  blockRequest: (
    urlPattern: string
  ): chrome.declarativeNetRequest.Rule => ({
    id: 0,
    priority: 1,
    action: {
      type: chrome.declarativeNetRequest.RuleActionType.BLOCK,
    },
    condition: {
      urlFilter: urlPattern,
    },
  }),

  // é‡å®šå‘è¯·æ±‚
  redirectRequest: (
    fromPattern: string,
    toUrl: string
  ): chrome.declarativeNetRequest.Rule => ({
    id: 0,
    priority: 1,
    action: {
      type: chrome.declarativeNetRequest.RuleActionType.REDIRECT,
      redirect: { url: toUrl },
    },
    condition: {
      urlFilter: fromPattern,
    },
  }),
};
```

### 4. è§£å†³è·¨åŸŸï¼ˆCORSï¼‰é—®é¢˜

#### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ declarativeNetRequest ä¿®æ”¹å“åº”å¤´

```typescript
// æ·»åŠ  CORS å“åº”å¤´
const corsRule: chrome.declarativeNetRequest.Rule = {
  id: 0,
  priority: 1,
  action: {
    type: chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,
    responseHeaders: [
      {
        header: 'Access-Control-Allow-Origin',
        operation: chrome.declarativeNetRequest.HeaderOperation.SET,
        value: '*',
      },
      {
        header: 'Access-Control-Allow-Methods',
        operation: chrome.declarativeNetRequest.HeaderOperation.SET,
        value: 'GET, POST, PUT, DELETE, OPTIONS',
      },
      {
        header: 'Access-Control-Allow-Headers',
        operation: chrome.declarativeNetRequest.HeaderOperation.SET,
        value: 'Content-Type, Authorization',
      },
    ],
  },
  condition: {
    urlFilter: '*api.example.com*',
    resourceTypes: [chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST],
  },
};
```

#### æ–¹æ¡ˆäºŒï¼šBackground ä»£ç†è¯·æ±‚

```typescript
// src/background/proxy.ts
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'FETCH_PROXY') {
    handleProxyRequest(message.url, message.options)
      .then(response => sendResponse({ success: true, data: response }))
      .catch(error => sendResponse({ success: false, error: error.message }));
    return true; // ä¿æŒé€šé“å¼€æ”¾
  }
});

async function handleProxyRequest(
  url: string,
  options: RequestInit = {}
): Promise<any> {
  // Background ä¸å— CORS é™åˆ¶
  const response = await fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      'User-Agent': 'Mozilla/5.0 (Custom)',
    },
  });

  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }

  const contentType = response.headers.get('content-type');
  if (contentType?.includes('application/json')) {
    return await response.json();
  }

  return await response.text();
}
```

#### Content Script ä¸­ä½¿ç”¨ä»£ç†

```typescript
// src/content/utils/fetch.ts
export async function fetchWithProxy(
  url: string,
  options: RequestInit = {}
): Promise<Response> {
  return new Promise((resolve, reject) => {
    chrome.runtime.sendMessage(
      {
        type: 'FETCH_PROXY',
        url,
        options: {
          method: options.method || 'GET',
          headers: options.headers,
          body: options.body,
        },
      },
      (response) => {
        if (response.success) {
          // æ„é€  Response å¯¹è±¡
          resolve(new Response(JSON.stringify(response.data)));
        } else {
          reject(new Error(response.error));
        }
      }
    );
  });
}
```

### 5. é«˜çº§åº”ç”¨åœºæ™¯

#### åœºæ™¯ä¸€ï¼šåŠ¨æ€åˆ‡æ¢ User-Agent

```typescript
// src/background/userAgentManager.ts
export class UserAgentManager {
  private rules = new Map<string, number>(); // domain -> ruleId

  async setUserAgent(domain: string, userAgent: string): Promise<void> {
    // ç§»é™¤æ—§è§„åˆ™
    const oldRuleId = this.rules.get(domain);
    if (oldRuleId) {
      await netRequestManager.removeRule(oldRuleId);
    }

    // æ·»åŠ æ–°è§„åˆ™
    const rule = ruleTemplates.modifyUserAgent(`*${domain}*`, userAgent);
    const newRuleId = await netRequestManager.addRule(rule);
    this.rules.set(domain, newRuleId);
  }

  async removeUserAgent(domain: string): Promise<void> {
    const ruleId = this.rules.get(domain);
    if (ruleId) {
      await netRequestManager.removeRule(ruleId);
      this.rules.delete(domain);
    }
  }
}
```

#### åœºæ™¯äºŒï¼šè¯·æ±‚é‡å®šå‘ï¼ˆMock æ•°æ®ï¼‰

```typescript
// src/background/mockManager.ts
export class MockManager {
  async mockApi(
    originalUrl: string,
    mockData: any
  ): Promise<void> {
    // å°† mock æ•°æ®ä¿å­˜åˆ° storage
    const mockId = `mock_${Date.now()}`;
    await chrome.storage.local.set({
      [mockId]: mockData,
    });

    // åˆ›å»ºé‡å®šå‘è§„åˆ™ï¼ŒæŒ‡å‘æˆ‘ä»¬çš„ mock endpoint
    const mockUrl = chrome.runtime.getURL(`mock.html?data=${mockId}`);
    const rule = ruleTemplates.redirectRequest(originalUrl, mockUrl);
    await netRequestManager.addRule(rule);
  }
}
```

#### åœºæ™¯ä¸‰ï¼šè¯·æ±‚é™æµ

```typescript
// src/background/rateLimiter.ts
export class RateLimiter {
  private requestCounts = new Map<string, number[]>();
  private blockRules = new Map<string, number>();

  async checkRateLimit(
    urlPattern: string,
    maxRequests: number,
    windowMs: number
  ): Promise<boolean> {
    const now = Date.now();
    const requests = this.requestCounts.get(urlPattern) || [];

    // æ¸…ç†è¿‡æœŸè®°å½•
    const validRequests = requests.filter(time => now - time < windowMs);

    if (validRequests.length >= maxRequests) {
      // è¶…è¿‡é™åˆ¶ï¼Œæ·»åŠ é˜»æ­¢è§„åˆ™
      if (!this.blockRules.has(urlPattern)) {
        const rule = ruleTemplates.blockRequest(urlPattern);
        const ruleId = await netRequestManager.addRule(rule);
        this.blockRules.set(urlPattern, ruleId);
      }
      return false;
    }

    // è®°å½•æœ¬æ¬¡è¯·æ±‚
    validRequests.push(now);
    this.requestCounts.set(urlPattern, validRequests);

    // ç§»é™¤é˜»æ­¢è§„åˆ™
    const blockRuleId = this.blockRules.get(urlPattern);
    if (blockRuleId) {
      await netRequestManager.removeRule(blockRuleId);
      this.blockRules.delete(urlPattern);
    }

    return true;
  }
}
```

## ğŸ› ï¸ å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹  1ï¼šå®ç°è¯·æ±‚å¤´ç®¡ç†å™¨

åˆ›å»ºä¸€ä¸ª UI ç•Œé¢ï¼Œå…è®¸ç”¨æˆ·ï¼š
1. ä¸ºç‰¹å®šåŸŸåæ·»åŠ /ä¿®æ”¹è¯·æ±‚å¤´
2. æŸ¥çœ‹å½“å‰æ‰€æœ‰è§„åˆ™
3. å¯ç”¨/ç¦ç”¨è§„åˆ™

```typescript
// src/popup/components/HeaderManager.vue
<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { NetRequestManager } from '@/background/netRequest';
import { ruleTemplates } from '@/shared/utils/netRequestTemplates';

const manager = new NetRequestManager();
const rules = ref<any[]>([]);
const newRule = ref({
  domain: '',
  headerName: 'User-Agent',
  headerValue: '',
});

async function loadRules() {
  rules.value = await manager.getAllRules();
}

async function addRule() {
  const rule = ruleTemplates.addCustomHeader(
    `*${newRule.value.domain}*`,
    newRule.value.headerName,
    newRule.value.headerValue
  );
  await manager.addRule(rule);
  await loadRules();
  newRule.value = { domain: '', headerName: 'User-Agent', headerValue: '' };
}

onMounted(loadRules);
</script>
```

### ç»ƒä¹  2ï¼šå®ç° CORS ä»£ç†æœåŠ¡

åˆ›å»ºä¸€ä¸ªé€šç”¨çš„ CORS ä»£ç†ï¼Œè®© Content Script å¯ä»¥è®¿é—®ä»»æ„ APIï¼š

```typescript
// src/background/corsProxy.ts
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'CORS_PROXY') {
    corsProxy(message.url, message.options)
      .then(data => sendResponse({ success: true, data }))
      .catch(err => sendResponse({ success: false, error: err.message }));
    return true;
  }
});

async function corsProxy(url: string, options: RequestInit) {
  const response = await fetch(url, {
    ...options,
    // æ·»åŠ å¸¸ç”¨ headers
    headers: {
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
      ...options.headers,
    },
  });

  const data = await response.json();
  return {
    status: response.status,
    statusText: response.statusText,
    headers: Object.fromEntries(response.headers.entries()),
    data,
  };
}
```

## ğŸ“ æ€»ç»“

- `declarativeNetRequest` æ˜¯ V3 ä¸­ç½‘ç»œæ‹¦æˆªçš„æ ‡å‡†æ–¹å¼
- åŠ¨æ€è§„åˆ™ç®¡ç†æä¾›çµæ´»çš„è¯·æ±‚ä¿®æ”¹èƒ½åŠ›
- Background ä»£ç†æ˜¯è§£å†³ CORS çš„æœ‰æ•ˆæ–¹æ¡ˆ
- åˆç†ä½¿ç”¨è§„åˆ™ä¼˜å…ˆçº§å’Œæ¡ä»¶åŒ¹é…

## ğŸ”— æ‰©å±•é˜…è¯»

- [declarativeNetRequest API](https://developer.chrome.com/docs/extensions/reference/declarativeNetRequest/)
- [è§„åˆ™ä¼˜å…ˆçº§å’ŒåŒ¹é…](https://developer.chrome.com/docs/extensions/reference/declarativeNetRequest/#rule-priorities)

