# 15. çƒ­æ›´æ–°æ¶æ„ (ç»•è¿‡å®¡æ ¸)

## ğŸ“š å­¦ä¹ ç›®æ ‡

- ç†è§£çƒ­æ›´æ–°çš„å¿…è¦æ€§
- å®ç°é…ç½®åŒ– UI ç³»ç»Ÿ
- ä½¿ç”¨ Sandbox Page åŠ¨æ€æ‰§è¡Œä»£ç 
- å®ç°æœåŠ¡ç«¯é…ç½®ä¸‹å‘

## ğŸ¯ æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. ä¸ºä»€ä¹ˆéœ€è¦çƒ­æ›´æ–°

Chrome å•†åº—å®¡æ ¸çš„é™åˆ¶ï¼š
- å®¡æ ¸å‘¨æœŸé•¿ï¼ˆå‡ å¤©åˆ°å‡ å‘¨ï¼‰
- é¢‘ç¹æ›´æ–°å¯èƒ½è¢«æ‹’ç»
- æŸäº›åŠŸèƒ½æ— æ³•é€šè¿‡å®¡æ ¸
- éœ€è¦å¿«é€Ÿä¿®å¤ bug æˆ–æ›´æ–°åŠŸèƒ½

### 2. é…ç½®åŒ– UI

#### æœåŠ¡ç«¯é…ç½®ç»“æ„

```json
// config.json (å­˜å‚¨åœ¨æœåŠ¡å™¨)
{
  "version": "1.0.0",
  "ui": {
    "popup": {
      "title": "æ’ä»¶é¢æ¿",
      "sections": [
        {
          "type": "button",
          "id": "btn-export",
          "label": "å¯¼å‡ºæ•°æ®",
          "action": "export"
        },
        {
          "type": "switch",
          "id": "switch-auto",
          "label": "è‡ªåŠ¨åŒæ­¥",
          "default": false
        }
      ]
    }
  },
  "features": {
    "feature-a": true,
    "feature-b": false
  }
}
```

#### å®¢æˆ·ç«¯é…ç½®åŠ è½½å™¨

```typescript
// src/shared/utils/configLoader.ts
export class ConfigLoader {
  private static config: any = null;
  private static configUrl = 'https://api.example.com/config';
  
  static async load(): Promise<any> {
    if (this.config) {
      return this.config;
    }
    
    try {
      const response = await fetch(`${this.configUrl}?v=${Date.now()}`);
      const config = await response.json();
      
      // ç¼“å­˜é…ç½®
      await chrome.storage.local.set({ config, configTimestamp: Date.now() });
      this.config = config;
      
      return config;
    } catch (e) {
      // ä½¿ç”¨ç¼“å­˜çš„é…ç½®
      const cached = await chrome.storage.local.get('config');
      if (cached.config) {
        this.config = cached.config;
        return cached.config;
      }
      throw e;
    }
  }
  
  static async refresh(): Promise<void> {
    this.config = null;
    await this.load();
  }
  
  static getFeature(name: string): boolean {
    return this.config?.features?.[name] || false;
  }
}
```

#### åŠ¨æ€ UI æ¸²æŸ“å™¨

```typescript
// src/popup/components/DynamicUI.vue
<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { ConfigLoader } from '@/shared/utils/configLoader';

const config = ref<any>(null);

onMounted(async () => {
  config.value = await ConfigLoader.load();
});

function handleAction(action: string) {
  chrome.runtime.sendMessage({ type: action });
}
</script>

<template>
  <div v-if="config">
    <h1>{{ config.ui.popup.title }}</h1>
    <div v-for="section in config.ui.popup.sections" :key="section.id">
      <component
        :is="section.type === 'button' ? 'button' : 'input'"
        :type="section.type === 'switch' ? 'checkbox' : undefined"
        @click="section.action && handleAction(section.action)"
      >
        {{ section.label }}
      </component>
    </div>
  </div>
</template>
```

### 3. Sandbox Page åŠ¨æ€æ‰§è¡Œ

#### manifest.json é…ç½®

```json
{
  "sandbox": {
    "pages": ["sandbox.html"]
  }
}
```

#### Sandbox é¡µé¢

```html
<!-- sandbox.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
</head>
<body>
  <script src="sandbox.js"></script>
</body>
</html>
```

```typescript
// sandbox.js
// è¿è¡Œåœ¨éš”ç¦»ç¯å¢ƒä¸­ï¼Œå¯ä»¥æ‰§è¡ŒåŠ¨æ€ä»£ç 

// ç›‘å¬æ¥è‡ªæ’ä»¶ä¸»çº¿ç¨‹çš„æ¶ˆæ¯
window.addEventListener('message', async (event) => {
  if (event.data.type === 'execute') {
    try {
      // åŠ¨æ€æ‰§è¡Œä»£ç 
      const result = await executeCode(event.data.code, event.data.context);
      
      // å‘é€ç»“æœå›ä¸»çº¿ç¨‹
      event.source.postMessage({
        type: 'result',
        id: event.data.id,
        result,
      }, '*');
    } catch (error) {
      event.source.postMessage({
        type: 'error',
        id: event.data.id,
        error: error.message,
      }, '*');
    }
  }
});

async function executeCode(code: string, context: any) {
  // åˆ›å»ºå®‰å…¨çš„æ‰§è¡Œç¯å¢ƒ
  const func = new Function('context', `
    const { ${Object.keys(context).join(', ')} } = context;
    return (${code})(context);
  `);
  
  return func(context);
}
```

#### ä¸»çº¿ç¨‹è°ƒç”¨

```typescript
// src/background/sandboxExecutor.ts
export class SandboxExecutor {
  private sandboxFrame: HTMLIFrameElement | null = null;
  
  async init() {
    this.sandboxFrame = document.createElement('iframe');
    this.sandboxFrame.src = chrome.runtime.getURL('sandbox.html');
    this.sandboxFrame.style.display = 'none';
    document.body.appendChild(this.sandboxFrame);
    
    return new Promise((resolve) => {
      this.sandboxFrame!.onload = resolve;
    });
  }
  
  async execute(code: string, context: any = {}): Promise<any> {
    if (!this.sandboxFrame) {
      await this.init();
    }
    
    const id = Date.now().toString();
    
    return new Promise((resolve, reject) => {
      const handler = (event: MessageEvent) => {
        if (event.data.id === id) {
          window.removeEventListener('message', handler);
          
          if (event.data.type === 'result') {
            resolve(event.data.result);
          } else {
            reject(new Error(event.data.error));
          }
        }
      };
      
      window.addEventListener('message', handler);
      
      this.sandboxFrame!.contentWindow!.postMessage({
        type: 'execute',
        id,
        code,
        context,
      }, '*');
      
      // è¶…æ—¶å¤„ç†
      setTimeout(() => {
        window.removeEventListener('message', handler);
        reject(new Error('Execution timeout'));
      }, 10000);
    });
  }
}
```

### 4. æœåŠ¡ç«¯é…ç½®ç®¡ç†

#### é…ç½® API

```typescript
// æœåŠ¡ç«¯ API (ç¤ºä¾‹)
// GET /api/config
// è¿”å›æœ€æ–°çš„é…ç½®

// POST /api/config/update
// æ›´æ–°é…ç½®ï¼ˆéœ€è¦è®¤è¯ï¼‰
```

#### å®¢æˆ·ç«¯å®šæ—¶åŒæ­¥

```typescript
// src/background/configSync.ts
export class ConfigSync {
  private syncInterval: number | null = null;
  
  start() {
    // æ¯å°æ—¶åŒæ­¥ä¸€æ¬¡
    this.syncInterval = window.setInterval(async () => {
      try {
        await ConfigLoader.refresh();
        console.log('Config synced');
      } catch (e) {
        console.error('Config sync failed:', e);
      }
    }, 60 * 60 * 1000);
    
    // ç«‹å³åŒæ­¥ä¸€æ¬¡
    ConfigLoader.refresh();
  }
  
  stop() {
    if (this.syncInterval) {
      clearInterval(this.syncInterval);
      this.syncInterval = null;
    }
  }
}
```

## ğŸ“ æ€»ç»“

- é…ç½®åŒ– UI å…è®¸é€šè¿‡æœåŠ¡ç«¯æ›´æ–°ç•Œé¢
- Sandbox Page å¯ä»¥å®‰å…¨æ‰§è¡ŒåŠ¨æ€ä»£ç 
- çƒ­æ›´æ–°ç»•è¿‡å•†åº—å®¡æ ¸ï¼Œå¿«é€Ÿè¿­ä»£
- éœ€è¦æ³¨æ„å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ

## âš ï¸ æ³¨æ„äº‹é¡¹

- ä¸è¦æ»¥ç”¨çƒ­æ›´æ–°åŠŸèƒ½
- ç¡®ä¿é…ç½®æ¥æºå¯ä¿¡
- åŠ¨æ€ä»£ç æ‰§è¡Œè¦æ³¨æ„å®‰å…¨
- éµå®ˆ Chrome å•†åº—æ”¿ç­–

