# 16. å•†ä¸šåŒ–æ¥å…¥

## ğŸ“š å­¦ä¹ ç›®æ ‡

- é›†æˆ Stripe/æ”¯ä»˜å®æ”¯ä»˜
- å®ç°è®¢é˜…åˆ¶æ”¯ä»˜ç³»ç»Ÿ
- è®¾è®¡ç”¨æˆ·é‰´æƒæœºåˆ¶
- å®ç° License Key éªŒè¯

## ğŸ¯ æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. Stripe æ”¯ä»˜é›†æˆ

#### åç«¯ API

```typescript
// åç«¯ API (Node.js ç¤ºä¾‹)
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

// åˆ›å»ºæ”¯ä»˜ä¼šè¯
app.post('/api/create-checkout-session', async (req, res) => {
  const session = await stripe.checkout.sessions.create({
    payment_method_types: ['card'],
    line_items: [{
      price_data: {
        currency: 'usd',
        product_data: {
          name: 'æ’ä»¶é«˜çº§ç‰ˆ',
        },
        recurring: {
          interval: 'month',
        },
        unit_amount: 999, // $9.99
      },
      quantity: 1,
    }],
    mode: 'subscription',
    success_url: `${req.headers.origin}/success?session_id={CHECKOUT_SESSION_ID}`,
    cancel_url: `${req.headers.origin}/cancel`,
    client_reference_id: req.body.userId,
  });
  
  res.json({ sessionId: session.id });
});
```

#### æ’ä»¶ç«¯é›†æˆ

```typescript
// src/shared/utils/payment.ts
export class PaymentService {
  private apiUrl = 'https://api.example.com';
  
  async createCheckoutSession(planId: string): Promise<string> {
    const userId = await this.getUserId();
    
    const response = await fetch(`${this.apiUrl}/api/create-checkout-session`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, planId }),
    });
    
    const { sessionId } = await response.json();
    return sessionId;
  }
  
  async openCheckout(sessionId: string) {
    // æ‰“å¼€ Stripe Checkout é¡µé¢
    chrome.tabs.create({
      url: `https://checkout.stripe.com/pay/${sessionId}`,
    });
    
    // ç›‘å¬æ”¯ä»˜æˆåŠŸ
    this.listenForPaymentSuccess(sessionId);
  }
  
  private async listenForPaymentSuccess(sessionId: string) {
    // è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
    const checkInterval = setInterval(async () => {
      const status = await this.checkPaymentStatus(sessionId);
      if (status === 'paid') {
        clearInterval(checkInterval);
        await this.onPaymentSuccess(sessionId);
      }
    }, 2000);
  }
  
  private async checkPaymentStatus(sessionId: string): Promise<string> {
    const response = await fetch(`${this.apiUrl}/api/payment-status/${sessionId}`);
    const { status } = await response.json();
    return status;
  }
  
  private async onPaymentSuccess(sessionId: string) {
    // æ¿€æ´» License
    const license = await this.fetchLicense(sessionId);
    await LicenseManager.validateLicense(license.key);
    
    // é€šçŸ¥ç”¨æˆ·
    chrome.notifications.create({
      type: 'basic',
      iconUrl: chrome.runtime.getURL('icon.png'),
      title: 'æ”¯ä»˜æˆåŠŸ',
      message: 'æ‚¨çš„è®¢é˜…å·²æ¿€æ´»ï¼',
    });
  }
  
  private async getUserId(): Promise<string> {
    const { userId } = await chrome.storage.local.get('userId');
    if (!userId) {
      const newUserId = this.generateUserId();
      await chrome.storage.local.set({ userId: newUserId });
      return newUserId;
    }
    return userId;
  }
  
  private generateUserId(): string {
    return `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }
}
```

### 2. License Key ç³»ç»Ÿ

#### License ç”Ÿæˆï¼ˆæœåŠ¡ç«¯ï¼‰

```typescript
// æœåŠ¡ç«¯ License ç”Ÿæˆ
import crypto from 'crypto';

function generateLicense(userId: string, features: string[]): string {
  const license = {
    userId,
    features,
    issuedAt: Date.now(),
    expiresAt: Date.now() + 30 * 24 * 60 * 60 * 1000, // 30å¤©
  };
  
  const data = JSON.stringify(license);
  const signature = crypto
    .createHmac('sha256', SECRET_KEY)
    .update(data)
    .digest('hex');
  
  const licenseData = { ...license, signature };
  return btoa(JSON.stringify(licenseData));
}
```

#### License éªŒè¯ï¼ˆæ’ä»¶ç«¯ï¼‰

```typescript
// src/background/licenseValidator.ts
export class LicenseValidator {
  async validate(licenseKey: string): Promise<{
    valid: boolean;
    features?: string[];
    expiresAt?: number;
  }> {
    try {
      const decoded = JSON.parse(atob(licenseKey));
      
      // éªŒè¯ç­¾åï¼ˆéœ€è¦æœåŠ¡ç«¯éªŒè¯ï¼‰
      const valid = await this.verifySignature(decoded);
      if (!valid) {
        return { valid: false };
      }
      
      // æ£€æŸ¥è¿‡æœŸ
      if (decoded.expiresAt < Date.now()) {
        return { valid: false };
      }
      
      // ä¿å­˜ License
      await chrome.storage.local.set({
        license: licenseKey,
        licenseFeatures: decoded.features,
        licenseExpiresAt: decoded.expiresAt,
      });
      
      return {
        valid: true,
        features: decoded.features,
        expiresAt: decoded.expiresAt,
      };
    } catch (e) {
      return { valid: false };
    }
  }
  
  private async verifySignature(license: any): Promise<boolean> {
    // å‘é€åˆ°æœåŠ¡ç«¯éªŒè¯
    const response = await fetch('https://api.example.com/verify-license', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ license }),
    });
    
    const { valid } = await response.json();
    return valid;
  }
  
  async hasFeature(feature: string): Promise<boolean> {
    const { licenseFeatures } = await chrome.storage.local.get('licenseFeatures');
    return licenseFeatures?.includes(feature) || false;
  }
}
```

### 3. ç”¨æˆ·é‰´æƒç³»ç»Ÿ

```typescript
// src/background/auth.ts
export class AuthService {
  async login(email: string, password: string): Promise<boolean> {
    const response = await fetch('https://api.example.com/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    
    if (response.ok) {
      const { token, user } = await response.json();
      await chrome.storage.local.set({ authToken: token, user });
      return true;
    }
    
    return false;
  }
  
  async getAuthToken(): Promise<string | null> {
    const { authToken } = await chrome.storage.local.get('authToken');
    return authToken || null;
  }
  
  async isAuthenticated(): Promise<boolean> {
    const token = await this.getAuthToken();
    if (!token) return false;
    
    // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ
    try {
      const response = await fetch('https://api.example.com/auth/verify', {
        headers: { 'Authorization': `Bearer ${token}` },
      });
      return response.ok;
    } catch {
      return false;
    }
  }
}
```

## ğŸ“ æ€»ç»“

- Stripe/æ”¯ä»˜å®é›†æˆå®ç°æ”¯ä»˜åŠŸèƒ½
- License Key ç³»ç»Ÿä¿æŠ¤ä»˜è´¹åŠŸèƒ½
- ç”¨æˆ·é‰´æƒç¡®ä¿å®‰å…¨æ€§
- è®¢é˜…åˆ¶æä¾›æŒç»­æ”¶å…¥

